<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Gameplay.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>Gameplay.cpp</h1><a href="Gameplay_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00013 <span class="comment">//Basic Input/Output header:</span>
00014 <span class="preprocessor">#include &lt;iostream&gt;</span>
00015 
00016 <span class="comment">//Time header:</span>
00017 <span class="preprocessor">#include "time.h"</span>
00018 
00019 <span class="comment">//Game headers:</span>
00020 <span class="preprocessor">#include "<a class="code" href="Main_8h.html">Main.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="Blocks_8h.html">Blocks.h</a>"</span>
00022 <span class="preprocessor">#include "<a class="code" href="Gameplay_8h.html">Gameplay.h</a>"</span>
00023 
00033 <a class="code" href="classTetrisEngine.html#a0">TetrisEngine::TetrisEngine</a>(<span class="keywordtype">long</span> xpos, <span class="keywordtype">long</span> ypos)
00034 {
00035 
00036         m_x = xpos;
00037         m_y = ypos;
00038 
00039         m_screen = 0;
00040         m_gameField = 0;
00041         m_scoreBoard = 0;
00042 
00043         m_blocks[0] = 0;
00044         m_blocks[1] = 0;
00045         m_blocks[2] = 0;
00046         m_blocks[3] = 0;
00047         m_blocks[4] = 0;
00048         m_blocks[5] = 0;
00049 
00050         m_levelUpSound = 0;
00051         m_lineRemoveSound = 0;
00052         m_gameOverSound = 0;
00053 
00054         m_scoreFont = 0;
00055 
00056         m_bgr = <span class="keyword">new</span> <span class="keywordtype">char</span>[255];
00057 
00058         m_linesToRemoveCount = 0;
00059 
00060         m_level = 0;
00061         m_linesErased = 0;
00062 
00063         m_countScore = <span class="keyword">false</span>;           
00064         m_score = 0;
00065 
00066         m_smoothFactorX = 0.0;
00067         m_smoothFactorY = 0.0;
00068         m_smoothFactorFade = 0.0;
00069 
00070         m_deltaX = 0;
00071         m_deltaY = 0;
00072 
00073         m_gameOver = <span class="keyword">false</span>;
00074         m_winner = <span class="keyword">false</span>;
00075         m_pause = <span class="keyword">false</span>;
00076         m_bindNext = <span class="keyword">false</span>;
00077 
00078         m_soundEnabled = <span class="keyword">false</span>;
00079 
00080         setKeyConfig(<a class="code" href="Gameplay_8h.html#a13a8">RotateKey</a>, SDLK_UP);
00081         setKeyConfig(<a class="code" href="Gameplay_8h.html#a13a9">LeftKey</a>, SDLK_LEFT);
00082         setKeyConfig(<a class="code" href="Gameplay_8h.html#a13a10">RightKey</a>, SDLK_RIGHT);
00083         setKeyConfig(<a class="code" href="Gameplay_8h.html#a13a11">DownKey</a>, SDLK_DOWN);
00084 
00085         m_removing = <span class="keyword">false</span>;
00086 
00087         m_startTime = 0;
00088 
00089 }
00090 
00100 <a class="code" href="classTetrisEngine.html#a1">TetrisEngine::~TetrisEngine</a>()
00101 {
00102 
00103         <span class="keyword">delete</span> m_bgr;
00104         m_bgr = 0;
00105 
00106         m_linesToRemoveCount = 0;
00107 
00108         m_level = 0;
00109         m_linesErased = 0;
00110 
00111         m_countScore = <span class="keyword">false</span>;           
00112         m_score = 0;
00113 
00114         m_smoothFactorX = 0.0;
00115         m_smoothFactorY = 0.0;
00116         m_smoothFactorFade = 0.0;
00117 
00118         m_deltaX = 0;
00119         m_deltaY = 0;
00120 
00121         m_removing = <span class="keyword">false</span>;
00122 
00123         m_pause = <span class="keyword">false</span>;
00124         m_bindNext = <span class="keyword">false</span>;
00125 
00126         m_startTime = 0;
00127 
00128 }
00129 
00140 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a2">TetrisEngine::bindToGrid</a>(<a class="code" href="classBlock.html">Block</a> *b)
00141 {
00142 
00143         <span class="keywordtype">long</span> currentIndex = 0;
00144 
00145         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; 4; ++i)
00146         {
00147 
00148                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; 4; ++j)
00149                 {
00150 
00151                         currentIndex = (j * 4) + i;
00152 
00153                         <span class="keywordflow">if</span>(m_gameBlock.getY() + j &gt; -1)
00154                         {
00155 
00156                                 <span class="keywordflow">if</span>(m_gameBlock.getShape()[currentIndex] != 0)
00157                                 {
00158 
00159                                         m_grid[m_gameBlock.getX() + i][m_gameBlock.getY() + j] = m_gameBlock.getShape()[currentIndex];
00160                                         
00161                                 }
00162                                         
00163                         }
00164 
00165                 }
00166 
00167         }
00168 
00169         m_gameBlock.clear();
00170 
00171         m_gameBlock = m_nextBlock;
00172         m_nextBlock.createRandomBlock();
00173 
00174         m_gameBlock.setX(2);
00175         m_gameBlock.setY(-4);
00176 
00177 }
00178 
00189 <a class="code" href="Gameplay_8h.html#a12">CollisionState</a> <a class="code" href="classTetrisEngine.html#a3">TetrisEngine::blockCollision</a>(<a class="code" href="classBlock.html">Block</a> *b, <span class="keywordtype">long</span> deltaX, <span class="keywordtype">long</span> deltaY)
00190 {
00191 
00192         <span class="keywordtype">long</span> i = 0;
00193         <span class="keywordtype">long</span> j = 0;
00194 
00195         <span class="keywordtype">long</span> currentIndex = 0;
00196 
00197         <span class="keywordflow">for</span>(i = b-&gt;<a class="code" href="classBlock.html#a6">getX</a>() + deltaX; i &lt; b-&gt;<a class="code" href="classBlock.html#a6">getX</a>() + deltaX + 4; ++i)
00198         {
00199 
00200                 <span class="keywordflow">for</span>(j = b-&gt;<a class="code" href="classBlock.html#a7">getY</a>() + deltaY; j &lt; b-&gt;<a class="code" href="classBlock.html#a7">getY</a>() + deltaY + 4; ++j)
00201                 {
00202 
00203                         currentIndex = (i - b-&gt;<a class="code" href="classBlock.html#a6">getX</a>() - deltaX) + ((j - b-&gt;<a class="code" href="classBlock.html#a7">getY</a>() - deltaY) * 4);
00204 
00205                         <span class="keywordflow">if</span>(b-&gt;<a class="code" href="classBlock.html#a3">getShape</a>()[currentIndex] != 0)
00206                         {
00207 
00208                                 <span class="keywordflow">if</span>(i &lt; 0)
00209                                 {
00210 
00211                                         <span class="keywordflow">return</span> <a class="code" href="Gameplay_8h.html#a12a5">LeftBorderCollision</a>;
00212 
00213                                 }
00214 
00215                                 <span class="keywordflow">if</span>(i &gt; (<a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a> - 1))
00216                                 {
00217 
00218                                         <span class="keywordflow">return</span> <a class="code" href="Gameplay_8h.html#a12a4">RightBorderCollision</a>;
00219 
00220                                 }
00221 
00222                                 <span class="keywordflow">if</span>(j &gt; (<a class="code" href="Gameplay_8h.html#a1">GRID_ROWS</a> - 1))
00223                                 {
00224 
00225                                         <span class="keywordflow">return</span> <a class="code" href="Gameplay_8h.html#a12a7">DownCollision</a>;
00226 
00227                                 }
00228 
00229                                 <span class="keywordflow">if</span>(j &gt; -1)
00230                                 {
00231 
00232                                         <span class="keywordflow">if</span>(m_grid[i][j] != 0)
00233                                         {
00234 
00235                                                 <span class="keywordflow">return</span> <a class="code" href="Gameplay_8h.html#a12a6">BlockCollision</a>;
00236 
00237                                         }
00238 
00239                                 }
00240 
00241                         }
00242 
00243                 }
00244 
00245         }
00246 
00247         <span class="keywordflow">return</span> <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>;
00248 
00249 }
00250 
00263 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a4">TetrisEngine::changeBGR</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *newBGR)
00264 {
00265 
00266         <span class="keywordflow">if</span>(strcmp(newBGR, m_bgr) == 0)
00267         {
00268 
00269                 <span class="keywordflow">return</span>;
00270 
00271         }
00272 
00273         <span class="keywordflow">if</span>(m_gameField)
00274         {
00275         
00276                 SDL_FreeSurface(m_gameField);
00277                 m_gameField = 0;
00278 
00279         }
00280 
00281         <span class="keywordflow">if</span>(!m_gameField)        
00282                 m_gameField = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<span class="stringliteral">""</span>, newBGR);
00283 
00284         <span class="keywordflow">if</span>(!m_gameField)
00285         {
00286 
00287                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the game frame.\n"</span>);
00288 
00289                 <span class="keywordflow">return</span>;
00290 
00291         }
00292 
00293         <span class="keywordflow">if</span>(m_soundEnabled)
00294                 FSOUND_PlaySound(FSOUND_FREE, m_levelUpSound);
00295 
00296         sprintf(m_bgr, <span class="stringliteral">"%s"</span>, newBGR);
00297 
00298 }
00299 
00309 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a5">TetrisEngine::destroyGame</a>()
00310 {
00311 
00312         <span class="keywordflow">if</span>(m_blocks[0])
00313                 SDL_FreeSurface(m_blocks[0]);
00314         
00315         <span class="keywordflow">if</span>(m_blocks[1])
00316                 SDL_FreeSurface(m_blocks[1]);
00317         
00318         <span class="keywordflow">if</span>(m_blocks[2])
00319                 SDL_FreeSurface(m_blocks[2]);
00320         
00321         <span class="keywordflow">if</span>(m_blocks[3])
00322                 SDL_FreeSurface(m_blocks[3]);
00323         
00324         <span class="keywordflow">if</span>(m_blocks[4])
00325                 SDL_FreeSurface(m_blocks[4]);
00326         
00327         <span class="keywordflow">if</span>(m_blocks[5])
00328                 SDL_FreeSurface(m_blocks[5]);
00329 
00330         <span class="keywordflow">if</span>(m_scoreBoard)
00331         {
00332 
00333                 SDL_FreeSurface(m_scoreBoard);
00334                 m_scoreBoard = 0;
00335 
00336         }
00337 
00338         <span class="keywordflow">if</span>(m_gameField)
00339         {
00340         
00341                 SDL_FreeSurface(m_gameField);
00342                 m_gameField = 0;
00343 
00344         }
00345 
00346         <span class="keywordflow">if</span>(m_scoreFont)
00347         {
00348 
00349                 FreeFont(m_scoreFont);
00350 
00351                 m_scoreFont = 0;
00352 
00353         }
00354 
00355         <span class="keywordflow">if</span>(m_levelUpSound)
00356         {
00357                 
00358                 FSOUND_Sample_Free(m_levelUpSound);
00359                 
00360                 m_levelUpSound = 0;
00361 
00362         }
00363 
00364         <span class="keywordflow">if</span>(m_lineRemoveSound)
00365         {
00366                 
00367                 FSOUND_Sample_Free(m_lineRemoveSound);
00368                 
00369                 m_lineRemoveSound = 0;
00370 
00371         }
00372 
00373         <span class="keywordflow">if</span>(m_gameOverSound)
00374         {
00375                 
00376                 FSOUND_Sample_Free(m_gameOverSound);
00377                 
00378                 m_gameOverSound = 0;
00379 
00380         }
00381 
00382 }
00383 
00393 <span class="keywordtype">bool</span> <a class="code" href="classTetrisEngine.html#a6">TetrisEngine::drawGame</a>()
00394 {
00395 
00396         m_fieldRect.x = m_x;
00397         m_fieldRect.y = m_y;
00398 
00399         SDL_SetAlpha(m_gameField, SDL_SRCALPHA, 255);
00400         
00401         <span class="keywordflow">if</span>(SDL_BlitSurface(m_gameField, 0, m_screen, &amp;m_fieldRect) &lt; 0)
00402     {
00403                 
00404                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00405 
00406         }
00407 
00408         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; <a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a>; ++i)
00409         {
00410 
00411                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; <a class="code" href="Gameplay_8h.html#a1">GRID_ROWS</a>; ++j)
00412                 {
00413 
00414                         <span class="keywordflow">if</span>(m_grid[i][j] &gt; 0)
00415                         {
00416 
00417                                 m_blockRect.x = m_x + 5 + (i * m_blocks[m_grid[i][j] - 1]-&gt;w);
00418                                 m_blockRect.y = m_y + 6 + (j * m_blocks[m_grid[i][j] - 1]-&gt;h);
00419                                 m_blockRect.w = m_blocks[m_grid[i][j] - 1]-&gt;w;
00420                                 m_blockRect.h = m_blocks[m_grid[i][j] - 1]-&gt;h;
00421 
00422                                 <span class="keywordflow">if</span>(m_linesToRemoveCount &gt; 0)
00423                                 {
00424 
00425                                         <span class="keywordflow">if</span>(m_linesToRemove[j] == <span class="keyword">true</span>)
00426                                         {
00427                                         
00428                                                 SDL_SetAlpha(m_blocks[m_grid[i][j] - 1], SDL_SRCALPHA, 164 - (164 * m_smoothFactorFade));
00429 
00430                                         } <span class="keywordflow">else</span> {
00431 
00432                                                 SDL_SetAlpha(m_blocks[m_grid[i][j] - 1], SDL_SRCALPHA, 164);
00433 
00434                                         }
00435 
00436                                 } <span class="keywordflow">else</span> {
00437                                 
00438                                         SDL_SetAlpha(m_blocks[m_grid[i][j] - 1], SDL_SRCALPHA, 164);
00439 
00440                                 }
00441 
00442                                 <span class="keywordflow">if</span>(SDL_BlitSurface(m_blocks[m_grid[i][j] - 1], 0, m_screen, &amp;m_blockRect) &lt; 0)
00443                                 {
00444 
00445                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00446 
00447                                 }
00448                                 
00449                         }
00450 
00451                 }
00452 
00453         }
00454 
00455         {
00456 
00457                 <span class="keywordtype">long</span> currentIndex = 0;
00458 
00459                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; 4; ++i)
00460                 {
00461 
00462                         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; 4; ++j)
00463                         {
00464 
00465                                 currentIndex = (j * 4) + i;
00466 
00467                                 <span class="keywordflow">if</span>(m_gameBlock.getY() + j == -1)
00468                                 {
00469 
00470                                         SDL_Rect srcRect;
00471 
00472                                         srcRect.x = 0;
00473                                         srcRect.y = m_blocks[0]-&gt;h - (m_blocks[0]-&gt;h * m_smoothFactorY);
00474                                         srcRect.w = m_blocks[0]-&gt;w;
00475                                         srcRect.h = (m_blocks[0]-&gt;h * m_smoothFactorY) + 1;
00476 
00477                                         m_blockRect.x = m_x + 5 + ((m_gameBlock.getX() + i) * m_blocks[0]-&gt;w) + (long)(m_deltaX * m_smoothFactorX * 19);
00478                                         m_blockRect.y = m_y + 6 + ((m_gameBlock.getY() + j) * m_blocks[0]-&gt;h) + (long)(m_deltaY * m_smoothFactorY * 19) + m_blocks[0]-&gt;h - (m_blocks[0]-&gt;h * m_smoothFactorY);
00479                                         m_blockRect.w = m_blocks[0]-&gt;w;
00480                                         m_blockRect.h = (m_blocks[0]-&gt;h * m_smoothFactorY);
00481 
00482                                         SDL_SetAlpha(m_blocks[m_gameBlock.getShape()[currentIndex] - 1], SDL_SRCALPHA, 164);
00483 
00484                                         <span class="keywordflow">if</span>(m_gameBlock.getShape()[currentIndex] != 0)
00485                                         {
00486 
00487                                                 <span class="keywordflow">if</span>(SDL_BlitSurface(m_blocks[m_gameBlock.getShape()[currentIndex] - 1], &amp;srcRect, m_screen, &amp;m_blockRect) &lt; 0)
00488                                                 {
00489 
00490                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00491 
00492                                                 }
00493                                         
00494                                         }
00495                                         
00496                                 }
00497 
00498                                 <span class="keywordflow">if</span>(m_gameBlock.getY() + j &gt; -1)
00499                                 {
00500 
00501                                         m_blockRect.x = m_x + 5 + ((m_gameBlock.getX() + i) * m_blocks[0]-&gt;w) + (long)(m_deltaX * m_smoothFactorX * 19);
00502                                         m_blockRect.y = m_y + 6 + ((m_gameBlock.getY() + j) * m_blocks[0]-&gt;h) + (long)(m_deltaY * m_smoothFactorY * 19);
00503                                         m_blockRect.w = m_blocks[0]-&gt;w;
00504                                         m_blockRect.h = m_blocks[0]-&gt;h;
00505 
00506                                         SDL_SetAlpha(m_blocks[m_gameBlock.getShape()[currentIndex] - 1], SDL_SRCALPHA, 164);
00507 
00508                                         <span class="keywordflow">if</span>(m_gameBlock.getShape()[currentIndex] != 0)
00509                                         {
00510 
00511                                                 <span class="keywordflow">if</span>(SDL_BlitSurface(m_blocks[m_gameBlock.getShape()[currentIndex] - 1], 0, m_screen, &amp;m_blockRect) &lt; 0)
00512                                                 {
00513 
00514                                                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00515 
00516                                                 }
00517                                         
00518                                         }
00519                                         
00520                                 }
00521 
00522                         }
00523 
00524                 }
00525 
00526         }
00527 
00528         m_scoreRect.x = m_fieldRect.x + m_fieldRect.w + 15;
00529         m_scoreRect.y = m_fieldRect.y;
00530         m_scoreRect.w = m_scoreBoard-&gt;w;
00531         m_scoreRect.h = m_scoreBoard-&gt;h;
00532 
00533         <span class="keywordflow">if</span>(SDL_BlitSurface(m_scoreBoard, 0, m_screen, &amp;m_scoreRect) &lt; 0)
00534         {
00535 
00536                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00537 
00538         }
00539 
00540         {
00541 
00542                 <span class="keywordtype">char</span> text[80];
00543 
00544                 sprintf(text, <span class="stringliteral">"Lines:  %d"</span>, m_linesErased);
00545 
00546                 PutStringFont(m_screen, m_scoreFont, m_fieldRect.x + m_fieldRect.w + 15 + 15, m_fieldRect.y + 15, text);
00547 
00548                 <span class="keywordflow">if</span>(m_countScore)
00549                 {
00550 
00551                         sprintf(text, <span class="stringliteral">"Score:  %d"</span>, m_score);
00552 
00553                         PutStringFont(m_screen, m_scoreFont, m_fieldRect.x + m_fieldRect.w + 15 + 15, m_fieldRect.y + 15 + 30, text);
00554         
00555                 }
00556 
00557                 sprintf(text, <span class="stringliteral">"Next:"</span>);
00558                 
00559                 <span class="comment">//sprintf(text, "FPS: %d", (long)((m_framesDrawn * 1000) / (m_timeElapsed + 1)));</span>
00560 
00561                 PutStringFont(m_screen, m_scoreFont, m_fieldRect.x + m_fieldRect.w + 15 + 15, m_fieldRect.y + 15 + 60, text);
00562 
00563                 <span class="keywordflow">if</span>(m_winner || m_gameOver)
00564                 {
00565 
00566                         PutStringFont(m_screen, m_scoreFont, 20, m_screen-&gt;h - 40, <span class="stringliteral">"Press escape to abort game!"</span>);
00567 
00568                 }
00569 
00570                 <span class="keywordflow">if</span>(m_winner)
00571                 {
00572 
00573                         sprintf(text, <span class="stringliteral">"You win"</span>);
00574 
00575                         PutStringFont(m_screen, m_scoreFont, m_fieldRect.x + 20 + 25, m_fieldRect.y + m_fieldRect.h / 2 - 15, text);
00576 
00577                 }
00578 
00579                 <span class="keywordflow">if</span>(m_gameOver)
00580                 {
00581                 
00582                         sprintf(text, <span class="stringliteral">"Game Over"</span>);
00583 
00584                         PutStringFont(m_screen, m_scoreFont, m_fieldRect.x + 20 + 15, m_fieldRect.y + m_fieldRect.h / 2 - 15, text);
00585 
00586                 }
00587 
00588         }
00589 
00590         {
00591 
00592                 <span class="keywordtype">long</span> currentIndex = 0;
00593 
00594                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; 4; ++i)
00595                 {
00596 
00597                         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; 4; ++j)
00598                         {
00599 
00600                                 currentIndex = (j * 4) + i;
00601 
00602                                 m_blockRect.x = m_fieldRect.x + m_fieldRect.w + 15 + 15 + 50 + (i * m_blocks[0]-&gt;w);
00603                                 m_blockRect.y = m_fieldRect.y + 15 + 90 + (j * m_blocks[0]-&gt;h);
00604                                 m_blockRect.w = m_blocks[0]-&gt;w;
00605                                 m_blockRect.h = m_blocks[0]-&gt;h;
00606 
00607                                 SDL_SetAlpha(m_blocks[m_nextBlock.getShape()[currentIndex] - 1], SDL_SRCALPHA, 164);
00608 
00609                                 <span class="keywordflow">if</span>(m_nextBlock.getShape()[currentIndex] != 0)
00610                                 {
00611 
00612                                         <span class="keywordflow">if</span>(SDL_BlitSurface(m_blocks[m_nextBlock.getShape()[currentIndex] - 1], 0, m_screen, &amp;m_blockRect) &lt; 0)
00613                                         {
00614 
00615                                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00616 
00617                                         }
00618                                         
00619                                 }
00620                                         
00621                         }
00622 
00623                 }
00624 
00625         }
00626 
00627         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00628 
00629 }
00630 
00641 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a7">TetrisEngine::eliminateRows</a>()
00642 {
00643 
00644         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; <a class="code" href="Gameplay_8h.html#a1">GRID_ROWS</a>; ++i)
00645         {
00646 
00647                 <span class="keywordtype">long</span> count = 0;
00648 
00649                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; <a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a>; ++j)
00650                 {
00651 
00652                         <span class="keywordflow">if</span>(m_grid[j][i] &gt; 0)
00653                         {
00654 
00655                                 ++count;
00656 
00657                         }
00658 
00659                         <span class="keywordflow">if</span>(count == <a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a>)
00660                         {
00661 
00662                                 m_smoothFactorY = 0;
00663 
00664                                 m_removing = <span class="keyword">true</span>;
00665 
00666                                 m_linesToRemove[i] = <span class="keyword">true</span>;
00667 
00668                                 ++m_linesToRemoveCount;
00669 
00670                         } <span class="keywordflow">else</span> {
00671 
00672                                 m_linesToRemove[i] = <span class="keyword">false</span>;
00673 
00674                         }
00675 
00676                 }
00677 
00678         }
00679 
00680         <span class="keywordflow">if</span>(m_removing)
00681         {
00682 
00683                 <span class="keywordflow">if</span>(m_soundEnabled)
00684                 {
00685                         
00686                         FSOUND_PlaySound(FSOUND_FREE, m_lineRemoveSound);
00687 
00688                 }
00689 
00690         }
00691 
00692 }
00693 
00704 <span class="keywordtype">long</span> <a class="code" href="classTetrisEngine.html#a11">TetrisEngine::getKeyConfig</a>(<a class="code" href="Gameplay_8h.html#a13">InputConfig</a> ic)
00705 {
00706 
00707         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a8">RotateKey</a>)
00708                 <span class="keywordflow">return</span> m_rotateKey;
00709         
00710         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a9">LeftKey</a>)
00711                 <span class="keywordflow">return</span> m_leftKey;
00712         
00713         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a10">RightKey</a>)
00714                 <span class="keywordflow">return</span> m_rightKey;
00715         
00716         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a11">DownKey</a>)
00717                 <span class="keywordflow">return</span> m_downKey;
00718 
00719         <span class="keywordflow">return</span> 0;
00720 
00721 }
00722 
00732 <span class="keywordtype">bool</span> <a class="code" href="classTetrisEngine.html#a19">TetrisEngine::loadGame</a>()
00733 {
00734 
00735         <span class="keywordtype">long</span> i = 0;
00736 
00737         sprintf(m_bgr, <span class="stringliteral">"gamefield1.jpg"</span>);
00738 
00739         <span class="keywordflow">if</span>(!m_gameField)        
00740                 m_gameField = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"gamefield1.jpg"</span>);
00741 
00742         <span class="keywordflow">if</span>(!m_gameField)
00743         {
00744 
00745                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the game frame.\n"</span>);
00746 
00747                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00748 
00749         }
00750 
00751         <span class="keywordflow">if</span>(!m_scoreBoard)       
00752                 m_scoreBoard = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"scoreboard.png"</span>);
00753 
00754         <span class="keywordflow">if</span>(!m_scoreBoard)
00755         {
00756 
00757                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the score board.\n"</span>);
00758                 
00759                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00760 
00761         }
00762 
00763         <span class="keywordflow">if</span>(!m_blocks[0])
00764                 m_blocks[0] = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"redblock.png"</span>);
00765         <span class="keywordflow">if</span>(!m_blocks[1])
00766                 m_blocks[1] = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"blueblock.png"</span>);
00767         <span class="keywordflow">if</span>(!m_blocks[2])
00768                 m_blocks[2] = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"yellowblock.png"</span>);
00769         <span class="keywordflow">if</span>(!m_blocks[3])
00770                 m_blocks[3] = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"greenblock.png"</span>);
00771         <span class="keywordflow">if</span>(!m_blocks[4])
00772                 m_blocks[4] = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"pinkblock.png"</span>);
00773         <span class="keywordflow">if</span>(!m_blocks[5])
00774                 m_blocks[5] = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"orangeblock.png"</span>);
00775 
00776         <span class="keywordflow">for</span>(i = 0; i &lt; 6; ++i)
00777         {
00778         
00779                 <span class="keywordflow">if</span>(!m_blocks[i])
00780                 {
00781 
00782                         <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the block bitmaps.\n"</span>);
00783 
00784                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00785 
00786                 }
00787 
00788         }
00789 
00790         SDL_SetColorKey(m_blocks[0], SDL_SRCCOLORKEY, 0xFFFFFF);
00791         SDL_SetColorKey(m_blocks[1], SDL_SRCCOLORKEY, 0xFFFFFF);
00792         SDL_SetColorKey(m_blocks[2], SDL_SRCCOLORKEY, 0xFFFFFF);
00793         SDL_SetColorKey(m_blocks[3], SDL_SRCCOLORKEY, 0xFFFFFF);
00794         SDL_SetColorKey(m_blocks[4], SDL_SRCCOLORKEY, 0xFFFFFF);
00795         SDL_SetColorKey(m_blocks[5], SDL_SRCCOLORKEY, 0xFFFFFF);
00796 
00797         m_fieldRect.x = m_x;
00798         m_fieldRect.y = m_y;
00799         m_fieldRect.w = m_blocks[0]-&gt;w * <a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a> + 10;
00800         m_fieldRect.h = m_blocks[0]-&gt;h * <a class="code" href="Gameplay_8h.html#a1">GRID_ROWS</a> + 10;
00801 
00802         m_gameBlock.createRandomBlock();
00803         m_nextBlock.createRandomBlock();
00804 
00805         m_gameBlock.setX(2);
00806         m_gameBlock.setY(-4);
00807         
00808         <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a>; ++i)
00809         {
00810 
00811                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; <a class="code" href="Gameplay_8h.html#a1">GRID_ROWS</a>; ++j)
00812                 {
00813 
00814                         m_grid[i][j] = 0;
00815 
00816                 }
00817 
00818         }
00819 
00820         <span class="keywordflow">if</span>(!m_scoreFont)
00821                 m_scoreFont = <a class="code" href="Util_8cpp.html#a1">loadFont</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, <span class="stringliteral">"topaz.png"</span>);
00822 
00823         <span class="keywordflow">if</span>(!m_scoreFont)
00824         {
00825 
00826                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the font.\n"</span>);
00827 
00828                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00829 
00830         }
00831 
00832         <span class="keywordflow">if</span>(!m_levelUpSound)
00833                 m_levelUpSound = <a class="code" href="Util_8cpp.html#a2">loadSound</a>(<a class="code" href="Main_8h.html#a1">SND_PATH</a>, <span class="stringliteral">"Levelup.ogg"</span>);
00834 
00835         <span class="keywordflow">if</span>(!m_levelUpSound)
00836         {
00837 
00838                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the level up sound.\n"</span>);
00839 
00840                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00841 
00842         }
00843 
00844         <span class="keywordflow">if</span>(!m_lineRemoveSound)
00845                 m_lineRemoveSound = <a class="code" href="Util_8cpp.html#a2">loadSound</a>(<a class="code" href="Main_8h.html#a1">SND_PATH</a>, <span class="stringliteral">"Blipp.ogg"</span>);
00846 
00847         <span class="keywordflow">if</span>(!m_lineRemoveSound)
00848         {
00849 
00850                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the line removal sound.\n"</span>);
00851 
00852                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00853 
00854         }
00855 
00856         <span class="keywordflow">if</span>(!m_gameOverSound)
00857                 m_gameOverSound = <a class="code" href="Util_8cpp.html#a2">loadSound</a>(<a class="code" href="Main_8h.html#a1">SND_PATH</a>, <span class="stringliteral">"Gameover.ogg"</span>);
00858 
00859         <span class="keywordflow">if</span>(!m_gameOverSound)
00860         {
00861 
00862                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the line removal sound.\n"</span>);
00863 
00864                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00865 
00866         }
00867 
00868         resetGame();    
00869 
00870         m_startTime = SDL_GetTicks();
00871 
00872         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00873 
00874 }
00875 
00885 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a20">TetrisEngine::resetGame</a>()
00886 {
00887 
00888         sprintf(m_bgr, <span class="stringliteral">"%s"</span>, <span class="stringliteral">"gamefield1.jpg"</span>);
00889 
00890         <span class="keywordflow">if</span>(m_gameField)
00891         {
00892         
00893                 SDL_FreeSurface(m_gameField);
00894                 m_gameField = 0;
00895 
00896         }
00897 
00898         <span class="keywordflow">if</span>(!m_gameField)        
00899                 m_gameField = <a class="code" href="Util_8cpp.html#a0">loadImg</a>(<a class="code" href="Main_8h.html#a0">GFX_PATH</a>, m_bgr);
00900 
00901         <span class="keywordflow">if</span>(!m_gameField)
00902         {
00903 
00904                 <a class="code" href="namespaceLogFile.html#a4">writeLog</a>(<span class="stringliteral">"Failed to load the game frame.\n"</span>);
00905 
00906                 <span class="keywordflow">return</span>;
00907 
00908         }
00909 
00910         m_gameBlock.createRandomBlock();
00911 
00912         m_gameBlock.setX(2);
00913         m_gameBlock.setY(-4);
00914         
00915         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; <a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a>; ++i)
00916         {
00917 
00918                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; <a class="code" href="Gameplay_8h.html#a1">GRID_ROWS</a>; ++j)
00919                 {
00920 
00921                         m_grid[i][j] = <a class="code" href="Blocks_8h.html#a0">NO_BLOCK</a>;
00922 
00923                 }
00924 
00925         }
00926 
00927         m_deltaY = 1;
00928         m_deltaX = 0;
00929 
00930         m_gameOver = <span class="keyword">false</span>;
00931         m_pause = <span class="keyword">false</span>;
00932         m_winner = <span class="keyword">false</span>;
00933 
00934         m_level = 0;
00935         m_linesErased = 0;
00936         m_score = 0;
00937 
00938         m_startTime = SDL_GetTicks();
00939 
00940 }
00941 
00954 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a24">TetrisEngine::setLevel</a>(<span class="keywordtype">long</span> newLevel)
00955 {
00956         
00957         <span class="keywordflow">if</span>(newLevel &gt;= 0 &amp;&amp; newLevel &lt; <a class="code" href="Gameplay_8h.html#a2">MAX_LEVELS</a>)
00958         {
00959                 
00960                 m_level = newLevel;
00961 
00962         }
00963 
00964 }
00965 
00976 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a23">TetrisEngine::setKeyConfig</a>(<a class="code" href="Gameplay_8h.html#a13">InputConfig</a> ic, <span class="keywordtype">long</span> newKey)
00977 {
00978 
00979         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a8">RotateKey</a>)
00980                 m_rotateKey = newKey;
00981         
00982         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a9">LeftKey</a>)
00983                 m_leftKey = newKey;
00984         
00985         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a10">RightKey</a>)
00986                 m_rightKey = newKey;
00987         
00988         <span class="keywordflow">if</span>(ic == <a class="code" href="Gameplay_8h.html#a13a11">DownKey</a>)
00989                 m_downKey = newKey;
00990 
00991 }
00992 
01006 <span class="keywordtype">void</span> <a class="code" href="classTetrisEngine.html#a31">TetrisEngine::updateGame</a>()
01007 {
01008 
01009         <a class="code" href="Gameplay_8h.html#a12">CollisionState</a> cs = <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>;
01010 
01011         <span class="keywordtype">long</span> timeElapsed = 0;
01012 
01013         <span class="keywordflow">if</span>(!m_removing)
01014                 eliminateRows();
01015 
01016         <span class="keywordflow">if</span>(g_keys[m_leftKey] &amp;&amp; !g_keys[m_rotateKey] &amp;&amp; !m_pause)
01017         {
01018 
01019                 g_keys[m_leftKey] = <span class="keyword">false</span>;
01020 
01021                 cs = blockCollision(&amp;m_gameBlock, -1, m_deltaY);
01022 
01023                 <span class="keywordflow">if</span>(cs == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01024                 {
01025                                 
01026                         <span class="keywordflow">if</span>(m_deltaX == 0)
01027                                 m_deltaX = -1;
01028 
01029                 }
01030 
01031         }
01032 
01033         <span class="keywordflow">if</span>(g_keys[m_rightKey] &amp;&amp; !g_keys[m_rotateKey] &amp;&amp; !m_pause)
01034         {
01035 
01036                 g_keys[m_rightKey] = <span class="keyword">false</span>;
01037 
01038                 cs = blockCollision(&amp;m_gameBlock, 1, m_deltaY);
01039 
01040                 <span class="keywordflow">if</span>(cs == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01041                 {
01042                                 
01043                         <span class="keywordflow">if</span>(m_deltaX == 0)
01044                                 m_deltaX = 1;
01045 
01046                 }
01047 
01048         }
01049         
01050         <span class="keywordflow">if</span>(g_keys[m_downKey] &amp;&amp; !g_keys[m_rotateKey] &amp;&amp; !m_pause &amp;&amp; !m_gameOver &amp;&amp; !m_winner)
01051         {
01052 
01053                 <span class="keywordflow">if</span>(m_gameBlock.getY() &gt; -1)
01054                 {
01055 
01056                         <span class="keywordflow">while</span>(blockCollision(&amp;m_gameBlock, 0, 1) == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01057                         {
01058 
01059                                 m_gameBlock.setY(m_gameBlock.getY() + 1);
01060 
01061                         }
01062 
01063                 }
01064 
01065         }
01066 
01067         <span class="keywordflow">if</span>(g_keys[m_rotateKey] &amp;&amp; !m_pause &amp;&amp; !m_gameOver &amp;&amp; !m_winner)
01068         {
01069 
01070                 g_keys[m_rotateKey] = <span class="keyword">false</span>;
01071 
01072                 m_gameBlock.rotate(<span class="keyword">false</span>);
01073                 
01074                 cs = blockCollision(&amp;m_gameBlock, m_deltaX, 0);
01075 
01076                 <span class="keywordflow">if</span>(cs == <a class="code" href="Gameplay_8h.html#a12a5">LeftBorderCollision</a>)
01077                 {
01078 
01079                         <a class="code" href="Gameplay_8h.html#a12">CollisionState</a> cs2 = blockCollision(&amp;m_gameBlock, m_deltaX + 1, 0);
01080 
01081                         <span class="keywordflow">if</span>(cs2 == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01082                         {
01083                 
01084                                 m_gameBlock.setX(m_gameBlock.getX() + 1);
01085 
01086                 
01087                         } <span class="keywordflow">else</span> {
01088 
01089                                 cs2 = blockCollision(&amp;m_gameBlock, m_deltaX + 2, 0);
01090 
01091                                 <span class="keywordflow">if</span>(cs2 == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01092                                 {
01093 
01094                                         m_gameBlock.setX(m_gameBlock.getX() + 2);
01095 
01096                                 }
01097 
01098                         }
01099                         
01100 
01101                 }
01102 
01103                 <span class="keywordflow">if</span>(cs == <a class="code" href="Gameplay_8h.html#a12a4">RightBorderCollision</a>)
01104                 {
01105 
01106                         <a class="code" href="Gameplay_8h.html#a12">CollisionState</a> cs2 = blockCollision(&amp;m_gameBlock, m_deltaX - 1, 0);
01107 
01108                         <span class="keywordflow">if</span>(cs2 == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01109                         {
01110                 
01111                                 m_gameBlock.setX(m_gameBlock.getX() - 1);
01112 
01113                 
01114                         } <span class="keywordflow">else</span> {
01115 
01116                                 cs2 = blockCollision(&amp;m_gameBlock, m_deltaX - 2, 0);
01117 
01118                                 <span class="keywordflow">if</span>(cs2 == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01119                                 {
01120 
01121                                         m_gameBlock.setX(m_gameBlock.getX() - 2);
01122 
01123                                 }
01124 
01125                         }
01126                         
01127 
01128                 }
01129 
01130                 cs = blockCollision(&amp;m_gameBlock, m_deltaX, 0);
01131                 
01132                 <span class="keywordflow">if</span>(cs != <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01133                         m_gameBlock.rotate(<span class="keyword">true</span>);
01134 
01135         }
01136 
01137         cs = blockCollision(&amp;m_gameBlock, m_deltaX, 1);
01138 
01139         <span class="keywordflow">if</span>(cs == <a class="code" href="Gameplay_8h.html#a12a3">NoCollision</a>)
01140         {
01141                         
01142                 <span class="keywordflow">if</span>(m_deltaY == 0)                       
01143                         m_deltaY = 1;
01144 
01145                 m_bindNext = <span class="keyword">false</span>;
01146 
01147         }
01148 
01149         <span class="keywordflow">if</span>(cs == <a class="code" href="Gameplay_8h.html#a12a6">BlockCollision</a>)
01150         {
01151 
01152                 <span class="keywordtype">long</span> firstRow = 0;
01153                 <span class="keywordtype">bool</span> set = <span class="keyword">false</span>;
01154 
01155                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; 4; ++i)
01156                 {
01157 
01158                         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; 4; ++j)
01159                         {
01160 
01161                                 <span class="keywordflow">if</span>(m_gameBlock.getShape()[(i * 4) + j] &gt; 0)
01162                                 {
01163 
01164                                         <span class="keywordflow">if</span>(!set)
01165                                                 firstRow = i;
01166 
01167                                         set = <span class="keyword">true</span>;
01168 
01169                                         i = 4;
01170                                         j = 4;
01171 
01172                                 }
01173 
01174                         }
01175 
01176                 }
01177 
01178                 <span class="keywordflow">if</span>((m_gameBlock.getY() + firstRow) &lt; 1)
01179                 {
01180 
01181                         <span class="keywordflow">if</span>(!m_gameOver)
01182                         {
01183                         
01184                                 <span class="keywordflow">if</span>(m_gameOverSound)
01185                                 {
01186 
01187                                         <span class="keywordflow">if</span>(m_soundEnabled)
01188                                         {
01189                                         
01190                                                 FSOUND_PlaySound(FSOUND_FREE, m_gameOverSound);
01191 
01192                                         }
01193 
01194                                 }
01195 
01196                         }
01197 
01198                         m_gameOver = <span class="keyword">true</span>;
01199 
01200                 }
01201 
01202                 m_smoothFactorY = 0;
01203                 m_deltaY = 0;
01204 
01205                 <span class="keywordflow">if</span>(m_bindNext &amp;&amp; m_smoothFactorY == 0)
01206                 {
01207 
01208                         bindToGrid(&amp;m_gameBlock);
01209 
01210                         m_bindNext = <span class="keyword">false</span>;
01211 
01212                 } <span class="keywordflow">else</span> {
01213 
01214                         m_bindNext = <span class="keyword">true</span>;
01215 
01216                 }
01217 
01218         }
01219 
01220         <span class="keywordflow">if</span>(cs == <a class="code" href="Gameplay_8h.html#a12a7">DownCollision</a>)
01221         {
01222 
01223                 m_deltaY = 0;
01224                                 
01225                 <span class="keywordflow">if</span>(m_bindNext &amp;&amp; m_smoothFactorY == 0)
01226                 {
01227 
01228                         bindToGrid(&amp;m_gameBlock);
01229 
01230                         m_bindNext = <span class="keyword">false</span>;
01231 
01232                 } <span class="keywordflow">else</span> {
01233 
01234                         m_bindNext = <span class="keyword">true</span>;
01235 
01236                 }
01237 
01238         }
01239 
01240         <span class="keywordflow">if</span>(m_gameOver || m_winner)
01241         {
01242         
01243                 timeElapsed = 0;
01244 
01245         } <span class="keywordflow">else</span> {
01246                 
01247                 timeElapsed = SDL_GetTicks() - m_startTime;
01248 
01249         }
01250 
01251         <span class="keywordflow">if</span>(m_removing &amp;&amp; !m_pause)
01252         {
01253 
01254                 m_smoothFactorFade += (0.0008 * timeElapsed);
01255                 
01256                 <span class="keywordflow">if</span>(m_smoothFactorFade &gt; 1.0)
01257                 {
01258 
01259                         m_smoothFactorY = 0;
01260                         timeElapsed = 0;
01261 
01262                         <span class="keywordflow">if</span>(m_countScore)
01263                         {
01264 
01265                                 m_score += (m_linesToRemoveCount * m_linesToRemoveCount) * 62;
01266 
01267                         }
01268         
01269                         m_linesErased += m_linesToRemoveCount;
01270 
01271                         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> j = 0; j &lt; <a class="code" href="Gameplay_8h.html#a1">GRID_ROWS</a>; ++j)
01272                         {
01273 
01274                                 <span class="keywordflow">if</span>(m_linesToRemove[j])
01275                                 {
01276                 
01277                                         <span class="keywordflow">for</span>(<span class="keywordtype">long</span> k = j; k &gt; 0; --k)
01278                                         {
01279 
01280                                                 <span class="keywordflow">for</span>(<span class="keywordtype">long</span> i = 0; i &lt; <a class="code" href="Gameplay_8h.html#a0">GRID_COLS</a>; ++i)
01281                                                 {
01282 
01283                                                         m_grid[i][k] = m_grid[i][k - 1];
01284 
01285                                                 }
01286 
01287                                         }
01288 
01289                                 }
01290 
01291                                 m_linesToRemoveCount--;
01292 
01293                                 m_linesToRemove[j] = <span class="keyword">false</span>;
01294 
01295                         }
01296 
01297                         m_smoothFactorFade = 0.0;
01298 
01299                         m_linesToRemoveCount = 0;
01300 
01301                         m_removing = <span class="keyword">false</span>;
01302 
01303                         <span class="keywordflow">return</span>;
01304 
01305                 }
01306                 
01307         }
01308 
01309         <span class="keywordflow">if</span>(m_pause)
01310                 timeElapsed = 0;
01311 
01312         <span class="keywordflow">if</span>(m_removing)
01313                 timeElapsed = 0;
01314 
01315         m_smoothFactorX += (0.020 * timeElapsed);
01316         m_smoothFactorY += ((0.004 + (m_level * 0.00035)) * timeElapsed);
01317 
01318         <span class="keywordflow">if</span>(m_smoothFactorX &gt;= 1)
01319         {
01320 
01321                 m_smoothFactorX = 0;
01322 
01323                 m_gameBlock.setX(m_gameBlock.getX() + m_deltaX);
01324 
01325                 m_deltaX = 0;
01326 
01327         }
01328 
01329         <span class="keywordflow">if</span>(m_smoothFactorY &gt;= 1)
01330         {
01331 
01332                 m_smoothFactorY = 0;
01333 
01334                 m_gameBlock.setY(m_gameBlock.getY() + m_deltaY);
01335 
01336                 m_deltaY = 0;
01337 
01338         }
01339 
01340         m_startTime = SDL_GetTicks();
01341 
01342 }
</pre></div><hr><address style="align: right;"><small>Generated on Wed Jan 8 19:41:41 2003 for Swift blocks by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
